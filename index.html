<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="记录我的学习、生活点滴">
<meta property="og:type" content="website">
<meta property="og:title" content="Glyme的小居">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Glyme的小居">
<meta property="og:description" content="记录我的学习、生活点滴">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Glyme的小居">
<meta name="twitter:description" content="记录我的学习、生活点滴">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> Glyme的小居 </title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Glyme的小居</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/24/sci/基于统计模型纠正Anki_GRE词典的分词错误/" itemprop="url">
                  基于统计模型纠正Anki_GRE词典的分词错误
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-09-24T21:15:35+08:00" content="2016-09-24">
              2016-09-24
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/science/" itemprop="url" rel="index">
                    <span itemprop="name">science</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/09/24/sci/基于统计模型纠正Anki_GRE词典的分词错误/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/24/sci/基于统计模型纠正Anki_GRE词典的分词错误/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在Anki软件中，使用的极品GRE卡牌组中的单词解释不知道怎么回事，单词经常被莫名其妙的断开。</p>
<p>比如<code>limp and flabby</code>被写成了<code>li mp and flabb y</code>，读起来很不爽。于是想通过程序自动纠正这种错误。</p>
<h2 id="方案1"><a href="#方案1" class="headerlink" title="方案1"></a>方案1</h2><p>一开始想到了一个很naive的方法：首先建立一个词典，然后每次读入一个词（空格分开）判断一下该词是否存在于词典中，如果不存在，判断该词与下一个词的组合是否在词典中，如果在，就把这两个词组合在一起并保存。</p>
<p>比如<code>flabb</code>不存在于词典，而<code>flabby</code>存在于词典，这样就能把这个错误纠正。</p>
<p>但是也有很多情况，即使一个单词被错误的分成了两个部分，但这两个部分依然是正确的单词。比如<code>li</code>和<code>mp</code>都存在于词典中，这样的方法就不能纠正这样的错误。</p>
<p>这是因为这个方案实在是too naive了，完全没有利用到上下文的关系。</p>
<h2 id="方案2"><a href="#方案2" class="headerlink" title="方案2"></a>方案2</h2><p>使用google的API，google会提供搜索建议，比如搜索<code>li mp and flabb y</code>，google会返回提示你是否要查询的是<code>limp and flabby</code>。</p>
<p>google搜索虽然功能很强大，但是由于众所周知的原因，最后没有采用。</p>
<h2 id="方案3"><a href="#方案3" class="headerlink" title="方案3"></a>方案3</h2><p>参考了<code>数学之美</code>和<code>Beautiful Data</code>中的分词方法，实际上就是比较$P(a_1,a_2,…,a_n)$与$P(b_1,b_2,…,b_n)$，其中$a_i,b_i$为两种分词方法第$i$个单词。</p>
<p>使用2阶模型，即马尔科夫模型，$P(x_1,x_2,…x_i)=P(x_1|x_2)<em>P(x_2|x_3)…</em>P(x_{n-1}|x_n)$。使用了<code>Beautiful Data</code>提供的统计数据。每次尝试合并句子中的一个空格，并选出概率较大的句子作为结果。注意原始分词方案增加了权重，这是因为原始分词方案大概率是正确的，因此给它加上一个权重。最后的正确率虽然达不到100%，但还是比较令人满意了。</p>
<p>完整代码如下，<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">import</span> sqlite3</div><div class="line"><span class="keyword">import</span> re</div><div class="line"><span class="keyword">import</span> urllib</div><div class="line"><span class="keyword">import</span> requests</div><div class="line"><span class="keyword">import</span> json</div><div class="line"><span class="keyword">import</span> time</div><div class="line"><span class="keyword">import</span> wordsegment</div><div class="line"><span class="keyword">from</span> math <span class="keyword">import</span> log10</div><div class="line"></div><div class="line"><span class="comment"># words dictionary</span></div><div class="line">words=frozenset()</div><div class="line"><span class="keyword">with</span> open(<span class="string">"words.txt"</span>) <span class="keyword">as</span> f:</div><div class="line">    words=frozenset([line.strip() <span class="keyword">for</span> line <span class="keyword">in</span> f])</div><div class="line"></div><div class="line"><span class="comment"># correct with google engine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">correct_google</span><span class="params">(s)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">extract_tag</span><span class="params">(s)</span>:</span></div><div class="line">        flag=<span class="keyword">False</span></div><div class="line">        ret=[]</div><div class="line">        tmp=<span class="string">""</span></div><div class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> s:</div><div class="line">            <span class="keyword">if</span> flag <span class="keyword">and</span> c==<span class="string">"&lt;"</span>:</div><div class="line">                ret.append(tmp)</div><div class="line">                tmp=<span class="string">""</span></div><div class="line">                flag=<span class="keyword">False</span></div><div class="line">            <span class="keyword">if</span> flag:</div><div class="line">                tmp+=c</div><div class="line">            <span class="keyword">if</span> <span class="keyword">not</span> flag <span class="keyword">and</span> c==<span class="string">"&gt;"</span>:</div><div class="line">                flag=<span class="keyword">True</span></div><div class="line">        <span class="keyword">return</span> ret</div><div class="line"></div><div class="line">    url=<span class="string">"http://www.google.co.jp/complete/search?client=serp&amp;hl=zh-CN&amp;gs_rn=64&amp;gs_ri=serp&amp;cp=13&amp;gs_id=3ms&amp;q=%s&amp;xhr=t"</span></div><div class="line">    url=url%urllib.quote(s)</div><div class="line"></div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            req=requests.get(url, timeout=<span class="number">10</span>)</div><div class="line"></div><div class="line">            js=json.loads(req.text)</div><div class="line">            flag=<span class="keyword">False</span></div><div class="line">            <span class="keyword">if</span> <span class="string">"o"</span> <span class="keyword">in</span> js[<span class="number">2</span>]:</div><div class="line">                s1=js[<span class="number">2</span>][<span class="string">"p"</span>]</div><div class="line">                s2=js[<span class="number">2</span>][<span class="string">"o"</span>]</div><div class="line">                t1=extract_tag(s1)</div><div class="line">                t2=extract_tag(s2)</div><div class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> range(len(t1)):</div><div class="line">                    <span class="comment"># correct word</span></div><div class="line">                    <span class="keyword">if</span>(t1[i].replace(<span class="string">" "</span>,<span class="string">""</span>)==t2[i]):</div><div class="line">                        <span class="keyword">print</span> t1[i], t2[i]</div><div class="line">                        s=s.replace(t1[i], t2[i])</div><div class="line">                        flag=<span class="keyword">True</span></div><div class="line">            <span class="keyword">break</span></div><div class="line">        <span class="keyword">except</span> Exception, ex:</div><div class="line">            <span class="keyword">print</span> str(ex)</div><div class="line">            time.sleep(<span class="number">1</span>)</div><div class="line"></div><div class="line">    <span class="keyword">return</span> flag,s</div><div class="line"></div><div class="line"><span class="comment"># correct using dictionary</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">correct_dict</span><span class="params">(s)</span>:</span></div><div class="line">    prev=<span class="string">""</span></div><div class="line">    w_list=s.split(<span class="string">" "</span>)[<span class="number">0</span>:<span class="number">-1</span>]</div><div class="line">    rst=[]</div><div class="line">    flag=<span class="keyword">False</span></div><div class="line">    <span class="keyword">for</span> w <span class="keyword">in</span> w_list:</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> w.lower() <span class="keyword">in</span> words <span class="keyword">and</span> (prev+w).lower() <span class="keyword">in</span> words:</div><div class="line">            <span class="keyword">del</span> rst[<span class="number">-1</span>]</div><div class="line">            rst.append(prev+w)</div><div class="line">            flag=<span class="keyword">True</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            rst.append(w)</div><div class="line">        prev=w</div><div class="line"></div><div class="line">    <span class="keyword">return</span> flag, <span class="string">' '</span>.join(rst)</div><div class="line"></div><div class="line"><span class="comment"># correct using segmentation and word score</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">correct_segmentation</span><span class="params">(s)</span>:</span></div><div class="line"></div><div class="line">    <span class="comment"># generate all possible sentences</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">generate_sentence</span><span class="params">(words)</span>:</span></div><div class="line">        <span class="comment"># original sentence</span></div><div class="line">        <span class="keyword">yield</span> words, <span class="number">0</span></div><div class="line"></div><div class="line">        <span class="comment"># sentence with one space removed</span></div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,len(words)):</div><div class="line">            tmp=words[:]</div><div class="line">            tmp[i<span class="number">-1</span>:i+<span class="number">1</span>]=[tmp[i<span class="number">-1</span>]+tmp[i]]</div><div class="line">            <span class="keyword">yield</span> tmp, i</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">score_sentence</span><span class="params">(<span class="params">(words, pos)</span>)</span>:</span></div><div class="line">        words=[<span class="string">'&lt;s&gt;'</span>,]+words</div><div class="line"></div><div class="line">        <span class="comment"># add weight for original sentence</span></div><div class="line">        ret=<span class="number">5</span> <span class="keyword">if</span> pos==<span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span></div><div class="line">        prev=<span class="string">"&lt;s&gt;"</span></div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,len(words)):</div><div class="line">            ret+=log10(wordsegment.score(words[i],prev))</div><div class="line">            prev=words[i]</div><div class="line">        <span class="keyword">return</span> ret, pos</div><div class="line"></div><div class="line">    lower_s = s.lower()</div><div class="line">    words = lower_s.split(<span class="string">' '</span>)</div><div class="line"></div><div class="line">    max_s, pos=max(generate_sentence(words),key=score_sentence)</div><div class="line">    max_s=<span class="string">" "</span>.join(max_s)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> pos!=<span class="number">0</span>:</div><div class="line">        ret=s.split(<span class="string">' '</span>)</div><div class="line">        ret[pos<span class="number">-1</span>:pos+<span class="number">1</span>]=[ret[pos<span class="number">-1</span>]+ret[pos]]</div><div class="line">        ret=<span class="string">' '</span>.join(ret)</div><div class="line">        <span class="keyword">print</span> ret</div><div class="line">        <span class="keyword">return</span> <span class="keyword">True</span>, ret</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">False</span>, s</div><div class="line"></div><div class="line"></div><div class="line">words_re=re.compile(<span class="string">'(\w+\s+)+\w+'</span>)</div><div class="line"></div><div class="line">conn=sqlite3.connect(<span class="string">'d:\xxx\Documents\Anki\User 1\collection.anki2'</span>)</div><div class="line"><span class="keyword">for</span> row <span class="keyword">in</span> conn.execute(<span class="string">'select id, flds from notes'</span>):</div><div class="line">    idd, fld = row</div><div class="line">    s_list=[m.group(<span class="number">0</span>) <span class="keyword">for</span> m <span class="keyword">in</span> words_re.finditer(fld)]</div><div class="line">    flag = <span class="keyword">False</span></div><div class="line">    <span class="keyword">for</span> s <span class="keyword">in</span> s_list:</div><div class="line">        <span class="comment"># corr, corr_s=correct_dict(s)</span></div><div class="line">        corr, corr_s=correct_segmentation(s)</div><div class="line"></div><div class="line">        <span class="keyword">if</span> corr:</div><div class="line">            flag=<span class="keyword">True</span></div><div class="line">            fld=fld.replace(s,corr_s)</div><div class="line">    <span class="keyword">if</span> flag:</div><div class="line">        conn.execute(<span class="string">'update notes set flds=? where id=?'</span>, (fld, idd))</div><div class="line">        conn.commit()</div><div class="line"></div><div class="line"></div><div class="line">conn.close()</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/24/life/让Chrome打印适应Kindle大小的PDF/" itemprop="url">
                  让Chrome打印适应Kindle大小的PDF
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-09-24T11:41:00+08:00" content="2016-09-24">
              2016-09-24
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/technology/" itemprop="url" rel="index">
                    <span itemprop="name">technology</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/09/24/life/让Chrome打印适应Kindle大小的PDF/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/24/life/让Chrome打印适应Kindle大小的PDF/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近发现一本深度学习的好书 <a href="http://neuralnetworksanddeeplearning.com/" target="_blank" rel="external">Neural Networks and Deep Learning</a>，想保存下载在Kindle上面阅读。</p>
<p>但是书中包含大量由MathJAX渲染的公式，无论是直接保存html或是另存为word，在Kindle上的阅读体验都比较糟糕。只有pdf格式才能完美的显示公式，于是想到使用chrome将网页保存为pdf格式。</p>
<p>首先使用<code>开发者工具</code>删掉网页中多余的元素，只保留书本内容，然后使用chrome的<code>打印pdf</code>功能将网页保存为pdf格式。</p>
<p>但chrome只能打印A4,A3等几种大小的pdf，这些大小在kindle上阅读体验也不好。</p>
<p>最适合kindle pw1的大小是 <code>85mmx114mm</code>。通过在CSS样式表里添加代码控制chrome打印pdf的大小，<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">@<span class="keyword">media</span> print&#123;</div><div class="line">    @<span class="keyword">page</span> &#123; <span class="attribute">size</span>:<span class="number">85mm</span> <span class="number">114mm</span>; <span class="attribute">margin-left</span>: <span class="number">2mm</span>; <span class="attribute">margin-right</span>: <span class="number">2mm</span> &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后打印、保存、上传到Kindle上，效果就很棒啦。</p>
<p><img src="/images/chromekindlepdf.png" alt="result_pdf"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/19/tech/通过斗鱼弹幕监控学习Scala/" itemprop="url">
                  Scala练手——斗鱼弹幕监控
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-09-19T17:19:00+08:00" content="2016-09-19">
              2016-09-19
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/technology/" itemprop="url" rel="index">
                    <span itemprop="name">technology</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/09/19/tech/通过斗鱼弹幕监控学习Scala/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/19/tech/通过斗鱼弹幕监控学习Scala/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Scala练手——斗鱼弹幕监控"><a href="#Scala练手——斗鱼弹幕监控" class="headerlink" title="Scala练手——斗鱼弹幕监控"></a>Scala练手——斗鱼弹幕监控</h1><h2 id="Why"><a href="#Why" class="headerlink" title="Why"></a>Why</h2><p>最近在学习hadoop, spark, kafka, zookeeper等大数据处理框架，也就顺带学习了一下scala这门编程语言，以阅读spark的源代码（spark核心使用scala编写）。没想到scala越学越上瘾，越来越喜欢函数式编程了。</p>
<p>在这里以<code>斗鱼弹幕监控</code>为课题，使用scala编写了一个斗鱼弹幕获取、分析的小程序练练手，在这里记录一下遇到的问题以及解决方案。</p>
<h2 id="斗鱼API"><a href="#斗鱼API" class="headerlink" title="斗鱼API"></a>斗鱼API</h2><p>斗鱼API使用时，需要与斗鱼服务器建立TCP长连接，使用心跳包维护连接，每一个连接对应一个斗鱼房间。当有消息时，斗鱼服务器会通过连接将消息推送过来。消息为Key-Value的格式，使用斗鱼自定义的序列化方法进行序列化，在客户端需要自行反序列化。</p>
<p>需要注意的是，斗鱼服务器限制连接个数，连接超出一定个数（我测试的是150）时，连接会被重置（RST）。</p>
<h2 id="程序实现"><a href="#程序实现" class="headerlink" title="程序实现"></a>程序实现</h2><p>程序需要实现以下功能：</p>
<ol>
<li>获取斗鱼房间列表，为每一个房间创建TCP长连接</li>
<li>监听每一个TCP连接，有消息时接收消息并打印</li>
<li>通过心跳包维护TCP连接</li>
</ol>
<h3 id="BiMap"><a href="#BiMap" class="headerlink" title="BiMap"></a>BiMap</h3><p>程序需要保存建立的长连接的信息，包括Socket和房间ID（room_id）的对应关系。由于Socket与房间ID一一对应，需要从Socket查房间ID，也需要从房间ID反查Socket，因此需要一个双向Map结构（BiMap）。</p>
<p>这里使用了两个ConcurrentHashMap构建了一个BiMap，保存Socket与room_id的双向映射关系。使用ConcurrentHashMap的原因是，创建TCP连接，向Map插入值时使用了多线程，因此需要使用线程安全类型。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BiMap</span>[<span class="type">TK</span>, <span class="type">TV</span>] </span>&#123;</div><div class="line">    <span class="keyword">val</span> leftMap: mutable.<span class="type">Map</span>[<span class="type">TK</span>, <span class="type">TV</span>] = <span class="keyword">new</span> <span class="type">ConcurrentHashMap</span>[<span class="type">TK</span>, <span class="type">TV</span>]()</div><div class="line">    <span class="keyword">val</span> rightMap: mutable.<span class="type">Map</span>[<span class="type">TV</span>, <span class="type">TK</span>] = <span class="keyword">new</span> <span class="type">ConcurrentHashMap</span>[<span class="type">TV</span>, <span class="type">TK</span>]()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">addItem</span></span>(key: <span class="type">TK</span>, value: <span class="type">TV</span>): <span class="type">Option</span>[<span class="type">TV</span>] = &#123;</div><div class="line">        rightMap.put(value, key)</div><div class="line">        leftMap.put(key, value)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">findLeft</span></span>(key: <span class="type">TK</span>): <span class="type">Option</span>[<span class="type">TV</span>] = &#123;</div><div class="line">        leftMap.get(key)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">findRight</span></span>(key: <span class="type">TV</span>): <span class="type">Option</span>[<span class="type">TK</span>] = &#123;</div><div class="line">        rightMap.get(key)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">deleteLeft</span></span>(key: <span class="type">TK</span>): <span class="type">Option</span>[<span class="type">TV</span>] = &#123;</div><div class="line">        leftMap.remove(key)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">deleteRight</span></span>(key: <span class="type">TV</span>): <span class="type">Option</span>[<span class="type">TK</span>] = &#123;</div><div class="line">        rightMap.remove(key)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="房间列表获取"><a href="#房间列表获取" class="headerlink" title="房间列表获取"></a>房间列表获取</h3><p>首先通过<code>getGameList</code>获取斗鱼房间类型列表，在通过<code>getRoomList</code>获取对应房间类型的房间列表。即斗鱼有很多房间类型，每一种房间类型下面又有许多房间。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">getGameList</span></span>: <span class="type">Future</span>[<span class="type">List</span>[<span class="type">Map</span>[<span class="type">String</span>, <span class="type">String</span>]]] = <span class="type">Future</span> &#123;</div><div class="line">    <span class="keyword">val</span> s = fromUrlWithTimeout(<span class="string">"http://open.douyucdn.cn/api/RoomApi/game"</span>)</div><div class="line">    <span class="keyword">val</span> root = parse(s)</div><div class="line">    <span class="keyword">val</span> ret: <span class="type">List</span>[<span class="type">Map</span>[<span class="type">String</span>, <span class="type">String</span>]] = <span class="keyword">for</span> &#123;</div><div class="line">        <span class="type">JField</span>(<span class="string">"data"</span>, <span class="type">JArray</span>(data)) &lt;- root</div><div class="line">        <span class="type">JObject</span>(categories) &lt;- data</div><div class="line">    &#125; <span class="keyword">yield</span> (<span class="keyword">for</span> &#123;</div><div class="line">        <span class="type">JField</span>(field, <span class="type">JString</span>(value)) &lt;- categories</div><div class="line">    &#125; <span class="keyword">yield</span> (field, value)) toMap</div><div class="line"></div><div class="line">    ret</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">getRoomList</span></span>(categoryId: <span class="type">Int</span>): <span class="type">Future</span>[<span class="type">List</span>[<span class="type">Map</span>[<span class="type">String</span>, <span class="type">String</span>]]] = <span class="type">Future</span> &#123;</div><div class="line">    <span class="keyword">val</span> s = fromUrlWithTimeout(<span class="string">s"http://open.douyucdn.cn/api/RoomApi/live/<span class="subst">$categoryId</span>"</span>)</div><div class="line">    <span class="keyword">val</span> root = parse(s)</div><div class="line">    <span class="keyword">val</span> ret: <span class="type">List</span>[<span class="type">Map</span>[<span class="type">String</span>, <span class="type">String</span>]] = <span class="keyword">for</span> &#123;</div><div class="line">        <span class="type">JField</span>(<span class="string">"data"</span>, <span class="type">JArray</span>(data)) &lt;- root</div><div class="line">        <span class="type">JObject</span>(rooms) &lt;- data</div><div class="line">    &#125; <span class="keyword">yield</span> (<span class="keyword">for</span> &#123;</div><div class="line">        <span class="type">JField</span>(field, <span class="type">JString</span>(value)) &lt;- rooms</div><div class="line">    &#125; <span class="keyword">yield</span> (field, value)) toMap</div><div class="line"></div><div class="line">    ret</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">val</span> dytask = <span class="keyword">for</span> &#123;</div><div class="line">        categories &lt;- <span class="type">DouyuAPI</span>.getGameList</div><div class="line">    &#125; <span class="keyword">yield</span> <span class="keyword">for</span> &#123;</div><div class="line">        category &lt;- categories</div><div class="line">        categoryId &lt;- category.get(<span class="string">"cate_id"</span>)</div><div class="line">    &#125; <span class="keyword">yield</span> &#123;</div><div class="line">        <span class="type">DouyuAPI</span>.getRoomList(categoryId.toInt)</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>这里使用了scala的Future实现异步IO。Future可以快速的创建多线程任务，返回的值为Future[T]类型的数据。通过liftweb.json库解析斗鱼房间信息并返回。返回值为键值对列表<code>[{key:value},{key:value}]</code></p>
<p><code>dytask</code>变量存储了所有房间的信息，类型为<code>Future[List[Future[List[Map[String, String]]]]]</code>。这里使用了scala的for关键字，scala的for关键字其实只是一个语法糖（syntax sugar），编译器会将for编译为一系列的map/flatMap/foreach/withFilter/filter。</p>
<p>具体如何展开可以参考官网的<a href="http://docs.scala-lang.org/tutorials/FAQ/yield.html" target="_blank" rel="external">FAQ</a>。</p>
<p>然后是使用返回的Future结构的数据，异步添加各个房间到监控列表中。<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">dytask onSuccess &#123;</div><div class="line">    <span class="keyword">case</span> categories =&gt;</div><div class="line">        categories foreach (_.onSuccess &#123;</div><div class="line">            <span class="keyword">case</span> room =&gt;</div><div class="line">                room foreach (_.get(<span class="string">"room_id"</span>) <span class="keyword">match</span> &#123;</div><div class="line">                    <span class="keyword">case</span> <span class="type">Some</span>(roomIdStr) =&gt;</div><div class="line">                        <span class="keyword">if</span> (roomSockMapping.leftMap.size &lt; <span class="number">150</span>) &#123;</div><div class="line">                            <span class="keyword">val</span> roomId = roomIdStr.toInt</div><div class="line">                            <span class="keyword">val</span> chann = <span class="type">SocketChannel</span>.open(<span class="keyword">new</span> <span class="type">InetSocketAddress</span>(<span class="type">HOST</span>, <span class="type">PORT</span>))</div><div class="line">                            chann.configureBlocking(<span class="literal">false</span>)</div><div class="line">                            <span class="keyword">val</span> selKey = chann.register(selector, <span class="type">SelectionKey</span>.<span class="type">OP_READ</span>)</div><div class="line"></div><div class="line">                            roomSockMapping.synchronized(&#123;</div><div class="line">                                <span class="keyword">if</span> (roomSockMapping.leftMap.size &lt; <span class="number">150</span>) &#123;</div><div class="line">                                    roomSockMapping.addItem(roomId, chann)</div><div class="line"></div><div class="line">                                    <span class="keyword">val</span> buff = <span class="type">ByteBuffer</span>.allocate(<span class="type">MAX_BUFFER_LENGTH</span>)</div><div class="line">                                    buff.order(<span class="type">ByteOrder</span>.<span class="type">LITTLE_ENDIAN</span>)</div><div class="line">                                    roomBufferMapping.put(chann, buff)</div><div class="line"></div><div class="line">                                    loginRoom(roomId)</div><div class="line">                                    joinGroup(roomId, <span class="number">-9999</span>)</div><div class="line">                                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                                    selKey.cancel()</div><div class="line">                                    chann.close()</div><div class="line">                                &#125;</div><div class="line">                            &#125;)</div><div class="line">                        &#125;</div><div class="line">                    <span class="keyword">case</span> <span class="type">None</span> =&gt;</div><div class="line">                        println(<span class="string">"error"</span>)</div><div class="line">                &#125;)</div><div class="line">        &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里使用了NIO的<code>Selector</code>，这样就可以在一个线程中同时监控多个Socket，注意Socket必须设置为非阻塞。Socket初始化，缓存初始化，初始房间登录消息都在这里完成。</p>
<h2 id="循环获取弹幕"><a href="#循环获取弹幕" class="headerlink" title="循环获取弹幕"></a>循环获取弹幕</h2><p>首先是使用selector监控Socket，当Socket可读时，读取Socket并将数据放入对应的缓存中。</p>
<p><code>proc</code>函数用于处理<em>一条</em>消息，在<code>proc</code>的尾部递归调用自身来处理剩余的消息。在其他命令式语言中一般使用循环来完成这个功能，但scala的循环没有break，不好实现这样的功能（无法在数据不足时break出循环），这是为了提倡函数式编程，函数式编程中都没有<code>while</code>语句，而是使用递归来实现与循环一样的效果。</p>
<p>尾递归通过编译器优化能够达到与<code>while</code>相同的效率，为了防止尾递归不规范，可以加上<code>@tailrec</code>让编译器检查，如果函数不能转化为尾递归编译器会报错。</p>
<p>这里使用了ByteBuffer作为缓冲，由于接收的信息可能不全无法处理，比如一条消息长度为2000字节，当前只收到了1000字节，那就需要等待下次读取了新内容后再次检查数据是否足够。因此buffer中可能还有尚未处理的数据，只能使用<code>compact</code>而不是<code>clear</code>。</p>
<p>使用<code>compact</code>会将没有处理的数据移到buffer头部，可能带来一定的开销。可以考虑使用<em>环形缓冲区</em>来实现ByteBuffer以降低移动数据带来的开销。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">getServerMsg</span> </span>= &#123;</div><div class="line">    <span class="meta">@tailrec</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">proc</span></span>(b: <span class="type">ByteBuffer</span>): <span class="type">Unit</span> = &#123;</div><div class="line">        <span class="keyword">if</span> (b.remaining() &gt; <span class="number">4</span>) &#123;</div><div class="line">            <span class="keyword">val</span> packetLen = b.getInt</div><div class="line">            <span class="keyword">if</span> (b.remaining() &gt;= packetLen) &#123;</div><div class="line">                <span class="keyword">if</span> (packetLen &lt;= <span class="type">MAX_BUFFER_LENGTH</span> &amp;&amp; packetLen &gt; <span class="number">0</span>) &#123;</div><div class="line">                    <span class="keyword">val</span> strMsg = <span class="keyword">new</span> <span class="type">String</span>(b.array(), b.position() + <span class="number">8</span>, packetLen - <span class="number">8</span>)</div><div class="line">                    b.position(b.position() + packetLen)</div><div class="line">                    parseServerMsg(<span class="type">DyMessage</span>(strMsg).msg)</div><div class="line">                    proc(b)</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    println(<span class="string">s"[FAIL] wrong length: <span class="subst">$packetLen</span>"</span>)</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                b.position(b.position() - <span class="number">4</span>)</div><div class="line">                println(<span class="string">"[INFO] not enough, wait for more..."</span>)</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//初始化获取弹幕服务器返回信息包大小</span></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">val</span> readyCount = selector.select(<span class="number">1000</span>)</div><div class="line">        <span class="keyword">for</span> &#123;key: <span class="type">SelectionKey</span> &lt;- selector.selectedKeys&#125; &#123;</div><div class="line">            <span class="keyword">if</span> (key.isReadable) &#123;</div><div class="line">                <span class="keyword">val</span> sock = key.channel().asInstanceOf[<span class="type">SocketChannel</span>]</div><div class="line">                <span class="keyword">val</span> buff = roomBufferMapping.get(sock).get</div><div class="line"></div><div class="line">                <span class="comment">// read new data into buffer</span></div><div class="line">                <span class="keyword">val</span> len = sock.read(buff)</div><div class="line">                buff.flip()</div><div class="line"></div><div class="line">                proc(buff)</div><div class="line">                buff.compact</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        selector.selectedKeys().clear()</div><div class="line">    &#125; <span class="keyword">catch</span> &#123;</div><div class="line">        <span class="keyword">case</span> ex: <span class="type">Exception</span> =&gt; ex.printStackTrace();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/13/tech/Spark Local模式可用但Standalone报错的解决方法/" itemprop="url">
                  Spark Local模式可用但Standalone报错的解决方法
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-09-13T15:47:21+08:00" content="2016-09-13">
              2016-09-13
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/technology/" itemprop="url" rel="index">
                    <span itemprop="name">technology</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/09/13/tech/Spark Local模式可用但Standalone报错的解决方法/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/13/tech/Spark Local模式可用但Standalone报错的解决方法/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>使用 Spark 的 Standalone 模式部署集群遇到了很多坑，记录一下。</p>
<h2 id="java-lang-ClassCastException"><a href="#java-lang-ClassCastException" class="headerlink" title="java.lang.ClassCastException"></a>java.lang.ClassCastException</h2><p>这个 stackoverflow 上面也有相关问题，但也没人解决，自己鼓捣了半天后，发现问题出在 spark-submit 的 jar 包名称含有空格…文件名去掉空格后就不会报错了</p>
<h2 id="各种ClassUndefined问题"><a href="#各种ClassUndefined问题" class="headerlink" title="各种ClassUndefined问题"></a>各种ClassUndefined问题</h2><p>首先检查一下有没有使用 sbt-assembly 把第三方 jar 包打包进去，或者使用 classpath 把jar包include进去。然后注意提交的 jar 包<em>要在所有Worker上都可见</em>，如果使用的posix文件名，要把jar包传到每一台Worker上，路径名称都要相同。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/13/tech/关于网络编程中 MTU、TCP、UDP 优化配置的一些总结 - 副本/" itemprop="url">
                  关于网络编程中 MTU、TCP、UDP 优化配置的一些总结
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-09-13T15:47:21+08:00" content="2016-09-13">
              2016-09-13
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/technology/" itemprop="url" rel="index">
                    <span itemprop="name">technology</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/09/13/tech/关于网络编程中 MTU、TCP、UDP 优化配置的一些总结 - 副本/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/13/tech/关于网络编程中 MTU、TCP、UDP 优化配置的一些总结 - 副本/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <div id="cnblogs_post_body"><p><span><span>首先要看 TCP/IP 协议，涉及到四层：链路层，网络层，传输层，应用层。</span>&nbsp;　　<br>其中以太网（Ethernet）的数据帧在链路层 　　<br><strong>IP 包</strong>在网络层 　　<br><strong>TCP 或 UDP 包</strong>在传输层 　　<br><strong>TCP 或 UDP 中的数据</strong>（Data) 在应用层 　　<br>它们的<strong>关系是</strong>&nbsp;数据帧｛IP 包｛TCP 或 UDP 包｛Data｝｝｝ 　　<br>———————————————————————————<br>在应用程序中我们用到的 Data 的长度最大是多少，直接取决于底层的限制。 　　<br>我们从下到上分析一下： 　　<br>1.<strong> 在链路层</strong>，由以太网的物理特性决定了数据帧的长度为（46＋18）－（1500＋18），其中的 18 是数据帧的头和尾，也就是说<strong>数据帧的内容最大为 1500</strong>（不包括帧头和帧尾），即 MTU（Maximum Transmission Unit）为 1500； 　<br>2.<strong> 在网络层</strong>，因为 IP 包的首部要占用 20 字节，所以这的 MTU 为 1500－20＝1480；　<br>3.<strong> 在传输层</strong>，对于 UDP 包的首部要占用 8 字节，所以这的 MTU 为 1480－8＝1472； 　　<br>所以，在应用层，你的 Data 最大长度为 1472。 （当我们的 UDP 包中的数据多于 MTU(1472) 时，发送方的 IP 层需要分片 fragmentation 进行传输，而在接收方 IP 层则需要进行数据报重组，由于 UDP 是不可靠的传输协议，如果分片丢失导致重组失败，将导致 UDP 数据包被丢弃）。 　　<br>从上面的分析来看，在普通的局域网环境下，UDP 的数据最大为 1472 字节最好（避免分片重组）。 　　<br>但在网络编程中，Internet 中的路由器可能有设置成不同的值（小于默认值），<strong>Internet 上的标准 MTU 值为 576</strong>，所以 Internet 的 UDP 编程时数据长度最好在 576－20－8＝548 字节以内。<br>———————————————————————————　　<br>MTU 对我们的 UDP 编程很重要，那如何查看路由的 MTU 值呢？ 　　<br>对于 windows OS: ping -f -l 　　如：ping -f -l 1472 192.168.0.1 　　<br>如果提示：Packets needs to be fragmented but DF set. 　　则表明 MTU 小于 1500，不断改小 data_length 值，可以最终测算出 gateway 的 MTU 值； 　　<br>对于 linux OS: ping -c -M do -s 　　如： ping -c 1 -M do -s 1472 192.168.0.1 　　<br>如果提示 Frag needed and DF set…… 　　则表明 MTU 小于 1500，可以再测以推算 gateway 的 MTU。</span></p><br><p><span>&nbsp;</span></p><br><div><span>原理：ping 程序使用 ICMP 报文，ICMP 报文首部占 8 字节，IP 数据报首部占 20 字节，因此在数据大小基础上加上 28 字节为 MTU 值。</span></div><br><p><span>———————————————————————————　</span></p><br><p><span><strong>IP 数据包的最大长度是 64K 字节 (65535)，</strong>因为在 IP 包头中用 2 个字节描述报文长度，2 个字节所能表达的最大数字就是 65535。&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>由于 IP 协议提供为上层协议<span>分割和重组报文的功能，因此传输层协议的数据包长度原则上来说没有限制。</span>实际上限制还是有的，因为 IP 包的标识字段终究不可能无限长，按照 IPv4，好像上限应该是 4G(64K*64K)。依靠这种机制，<strong>TCP 包头中就没有 “包长度” 字段，而完全依靠 IP 层去处理分帧。这就是为什么 TCP 常常被称作一种 “流协议” 的原因</strong>，开发者在使用 TCP 服务的时候，不必去关心数据包的大小，只需讲 SOCKET 看作一条数据流的入口，往里面放数据就是了，TCP 协议本身会进行拥塞 / 流量控制。&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>UDP 则与 TCP 不同，UDP 包头内有总长度字段，同样为两个字节，因此 UDP 数据包的总长度被限制为 65535，这样恰好可以放进一个 IP 包内，使得 UDP/IP 协议栈的实现非常简单和高效。65535 再减去 UDP 头本身所占据的 8 个字节，UDP 服务中的最大有效载荷长度仅为 65527。这个值也就是你在调用 getsockopt() 时指定 SO_MAX_MSG_SIZE 所得到返回值，任何使用 SOCK_DGRAM 属性的 socket，一次 send 的数据都不能超过这个值，否则必然得到一个错误。&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>那么，IP 包提交给下层协议时将会得到怎样的处理呢？这就取决于数据链路层协议了，一般的数据链路层协议都会负责将 IP 包分割成更小的帧，然后在目的端重组它。在 EtherNet 上，数据链路帧的大小如以上几位大侠所言。而如果是 IP&nbsp;&nbsp; over&nbsp;&nbsp; ATM，则 IP 包将被切分成一个一个的 ATM&nbsp;&nbsp; Cell，大小为 53 字节。</span></p><br><p><span>&nbsp;</span></p><br><p><span>一些典型的 MTU 值：&nbsp;</span></p><br><p><span>网络： &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;MTU 字节</span><br><span>超通道&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 　　 &nbsp;65535</span><br><span>16Mb/s 信息令牌环（IBM） &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 　　　　17914</span><br><span>4Mb/s 令牌环（IEEE802.5） &nbsp; &nbsp; &nbsp; &nbsp; 　　　　&nbsp;4464</span><br><span>FDDI&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;　　　 &nbsp;4352</span><br><span>以太网&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 　　 &nbsp;1500</span><br><span>IEEE802.3/802.2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 　　&nbsp;&nbsp;1492</span><br><span>X.25&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;　　 &nbsp; 576</span><br><span>点对点（低时延） &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;　&nbsp; 296</span></p><br><p><span>&nbsp; &nbsp; 路径 MTU：如果两台主机之间的通信要通过多个网络，那么每个网络的链路层就可能有不同的 MTU。重要的不是两台主机所在网络的 MTU 的值，重要的是两台通信主机路径中的最小 MTU。它被称作路径 MTU。</span></p><br><p><strong><span>Tcp 传输中的 nagle 算法</span></strong></p><br><p><span>　　TCP/IP 协议中，无论发送多少数据，总是要在数据前面加上协议头，同时，对方接收到数据，也需要发送 ACK 表示确认。为了尽可能的利用网络带宽，TCP 总是希望尽可能的发送足够大的数据。（一个连接会设置 MSS 参数，因此，TCP/IP 希望每次都能够以 MSS 尺寸的数据块来发送数据）。Nagle 算法就是为了尽可能发送大块数据，避免网络中充斥着许多小数据块。</span></p><br><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Nagle 算法的基本定义是任意时刻，最多只能有一个未被确认的小段。&nbsp;所谓 “小段”，指的是小于 MSS 尺寸的数据块，所谓 “未被确认”，是指一个数据块发送出去后，没有收到对方发送的 ACK 确认该数据已收到。</span></p><br><p><span>1. Nagle 算法的规则：</span></p><br><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;（1）如果包长度达到 MSS，则允许发送；</span></p><br><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;（2）如果该包含有 FIN，则允许发送；</span></p><br><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;（3）设置了 TCP_NODELAY 选项，则允许发送；</span></p><br><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;（4）未设置 TCP_CORK 选项时，若所有发出去的小数据包（包长度小于 MSS）均被确认，则允许发送；</span></p><br><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;（5）上述条件都未满足，但发生了超时（一般为 200ms），则立即发送。</span></p><br><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Nagle 算法只允许一个未被 ACK 的包存在于网络，它并不管包的大小，因此它事实上就是一个扩展的停 - 等协议，只不过它是基于包停 - 等的，而不是基于字节停 - 等的。Nagle 算法完全由 TCP 协议的 ACK 机制决定，这会带来一些问题，比如如果对端 ACK 回复很快的话，Nagle 事实上不会拼接太多的数据包，虽然避免了网络拥塞，网络总体的利用率依然很低。</span></p><br><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>Nagle</span><span> 算法是</span><span> silly&nbsp;window&nbsp;syndrome(SWS)</span><span> 预防算法的一个半集。</span>SWS 算法预防发送少量的数据，Nagle 算法是其在发送方的实现，而接收方要做的时不要通告缓冲空间的很小增长，不通知小窗口，除非缓冲区空间有显著的增长。这里显著的增长定义为完全大小的段（MSS）或增长到大于最大窗口的一半。</span></p><br><p><span>&nbsp;注意：BSD 的实现是允许在空闲链接上发送大的写操作剩下的最后的小段，也就是说，当超过 1 个 MSS 数据发送时，内核先依次发送完 n 个 MSS 的数据包，然后再发送尾部的小数据包，其间不再延时等待。（假设网络不阻塞且接收窗口足够大）。</span></p><br><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;举个例子，一开始 client 端调用 socket 的 write 操作将一个 int 型数据（称为 A 块）写入到网络中，由于此时连接是空闲的（也就是说还没有未被确认的小段），因此这个 int 型数据会被马上发送到 server 端，接着，client 端又调用 write 操作写入‘\r\n’（简称 B 块），这个时候，A 块的 ACK 没有返回，所以可以认为已经存在了一个未被确认的小段，所以 B 块没有立即被发送，一直等待 A 块的 ACK 收到（大概 40ms 之后），B 块才被发送。整个过程如图所示：</span></p><br><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这里还隐藏了一个问题，就是 A 块数据的 ACK 为什么 40ms 之后才收到？这是因为 TCP/IP 中不仅仅有 nagle 算法，还有一个 TCP 确认延迟机制&nbsp;。当 Server 端收到数据之后，它并不会马上向 client 端发送 ACK，而是会将 ACK 的发送延迟一段时间（假设为 t），它希望在 t 时间内 server 端会向 client 端发送应答数据，这样 ACK 就能够和应答数据一起发送，就像是应答数据捎带着 ACK 过去。在我之前的时间中，t 大概就是 40ms。这就解释了为什么’\r\n’（B 块）总是在 A 块之后 40ms 才发出。</span></p><br><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;当然，TCP 确认延迟 40ms 并不是一直不变的，TCP 连接的延迟确认时间一般初始化为最小值 40ms，随后根据连接的重传超时时间（RTO）、上次收到数据包与本次接收数据包的时间间隔等参数进行不断调整。另外可以通过设置 TCP_QUICKACK 选项来取消确认延迟。</span></p><br><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;关于 TCP 确认延迟的详细介绍可参考：<a href="http://blog.csdn.net/turkeyzhou/article/details/6764389" target="_blank" rel="external">http://blog.csdn.net/turkeyzhou/article/details/6764389</a></span></p><br><p><span>2.&nbsp;TCP_NODELAY&nbsp;选项</span></p><br><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;默认情况下，发送数据采用 Negale&nbsp;算法。这样虽然提高了网络吞吐量，但是实时性却降低了，在一些交互性很强的应用程序来说是不允许的，使用 TCP_NODELAY 选项可以禁止 Negale&nbsp;算法。</span></p><br><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;此时，应用程序向内核递交的每个数据包都会立即发送出去。需要注意的是，虽然禁止了 Negale&nbsp;算法，但网络的传输仍然受到 TCP 确认延迟机制的影响。</span></p><br><p><span>3.&nbsp;TCP_CORK&nbsp;选项</span></p><br><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;所谓的 CORK 就是塞子的意思，形象地理解就是用 CORK 将连接塞住，使得数据先不发出去，等到拔去塞子后再发出去。设置该选项后，内核会尽力把小数据包拼接成一个大的数据包（一个 MTU）再发送出去，当然若一定时间后（一般为 200ms，该值尚待确认），内核仍然没有组合成一个 MTU 时也必须发送现有的数据（不可能让数据一直等待吧）。</span></p><br><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;然而，TCP_CORK 的实现可能并不像你想象的那么完美，CORK 并不会将连接完全塞住。内核其实并不知道应用层到底什么时候会发送第二批数据用于和第一批数据拼接以达到 MTU 的大小，因此内核会给出一个时间限制，在该时间内没有拼接成一个大包（努力接近 MTU）的话，内核就会无条件发送。也就是说若应用层程序发送小包数据的间隔不够短时，TCP_CORK 就没有一点作用，反而失去了数据的实时性（每个小包数据都会延时一定时间再发送）。</span></p><br><p><span>4.&nbsp;Nagle 算法与 CORK 算法区别</span></p><br><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Nagle 算法和 CORK 算法非常类似，但是它们的着眼点不一样，Nagle 算法主要避免网络因为太多的小包（协议头的比例非常之大）而拥塞，而 CORK 算法则是为了提高网络的利用率，使得总体上协议头占用的比例尽可能的小。如此看来这二者在避免发送小包上是一致的，在用户控制的层面上，Nagle 算法完全不受用户 socket 的控制，你只能简单的设置 TCP_NODELAY 而禁用它，CORK 算法同样也是通过设置或者清除 TCP_CORK 使能或者禁用之，然而 Nagle 算法关心的是网络拥塞问题，只要所有的 ACK 回来则发包，而 CORK 算法却可以关心内容，在前后数据包发送间隔很短的前提下（很重要，否则内核会帮你将分散的包发出），即使你是分散发送多个小数据包，你也可以通过使能 CORK 算法将这些内容拼接在一个包内，如果此时用 Nagle 算法的话，则可能做不到这一点。</span></p><br><p><span>&nbsp;&nbsp;&nbsp;&nbsp;实际上 Nagle 算法并不是很复杂，他的主要职责是数据的累积，实际上有两个门槛：一个就是缓&nbsp;冲区中的字节数达到了一定量，另一个就是等待了一定的时间（一般的 Nagle 算法都是等待 200ms）；这两个门槛的任何一个达到都必须发送数据了。一般&nbsp;情况下，如果数据流量很大，第二个条件是永远不会起作用的，但当发送小的数据包时，第二个门槛就发挥作用了，防止数据被无限的缓存在缓冲区不是好事情哦。&nbsp;了解了 TCP 的 Nagle 算法的原理之后我们可以自己动手来实现一个类似的算法了，在动手之前我们还要记住一个重要的事情，也是我们动手实现 Nagle 算&nbsp;法的主要动机就是我想要紧急发送数据的时候就要发送了，所以对于上面的两个门槛之外还的增加一个门槛就是紧急数据发送。</span></p><br><p><span>&nbsp;&nbsp;&nbsp;&nbsp;对于我现在每秒钟 10 次数据发送，每次数据发送量固定在 85~100 字节的应用而言，如果采用默认的开启 Nagle 算法，我在发送端，固定每帧数据 85 个，间隔 100ms 发送一次，我在接受端（阻塞方式使用）接受的数据是 43&nbsp;138 交替出现，可能就是这个算法的时间阈值问题，如果关闭 Nagle 算法，在接收端就可以保证数据每次接收到的都是 85 帧。</span></p><br><p><span>&nbsp;&nbsp;&nbsp;&nbsp;Nagle 算法适用于小包、高延迟的场合，而对于要求交互速度的 b/s 或 c/s 就<span>不合适了。</span><span>socket</span><span> 在创建的时候，默认都是使用</span><span> Nagle</span><span> 算法的，这会导致交互速度严重</span>下降，所以需要 setsockopt 函数来设置 TCP_NODELAY 为 1. 不过取消了 Nagle 算法，就会导致 TCP 碎片增多，效率可能会降低。</span></p><br><p><span>关闭 nagle 算法, 以免影响性能，因为控制时控制端要发送很多数据量很小的数据包, 需要马上发送。</span></p><br><p><span>&nbsp;const&nbsp;char&nbsp;chOpt&nbsp;=&nbsp;1;</span></p><br><p><span>int&nbsp;nErr&nbsp;=&nbsp;setsockopt(pContext-&gt;m_Socket,&nbsp;IPPROTO_TCP,&nbsp;TCP_NODELAY,&nbsp;&amp;chOpt,&nbsp;sizeof(char));</span></p><br><p><span>if&nbsp;(nErr&nbsp;==&nbsp;-1)</span></p><br><p><span>{</span></p><br><p><span>&nbsp;&nbsp;&nbsp;&nbsp;TRACE(_T(“setsockopt()&nbsp;error\n”),WSAGetLastError());</span></p><br><p><span>&nbsp;&nbsp;&nbsp;&nbsp;return;</span></p><br><p><span>}</span></p><br><div><br><p><span>setsockopt(sockfd, SOL_TCP, TCP_CORK, &amp;on, sizeof(on)); //set TCP_CORK</span></p><br><p>&nbsp;</p><br><br></div><br><p><strong><span>TCP 传输小数据包效率问题</span></strong></p><br><p><span>摘要：当使用 TCP 传输小型数据包时，程序的设计是相当重要的。如果在设计方案中不对 TCP 数据包的</span><br><span>延迟应答，Nagle 算法，Winsock 缓冲作用引起重视，将会严重影响程序的性能。这篇文章讨论了这些</span><br><span>问题，列举了两个案例，给出了一些传输小数据包的优化设计方案。</span></p><br><p><span>背景：当 Microsoft TCP 栈接收到一个数据包时，会启动一个 200 毫秒的计时器。当 ACK 确认数据包</span><br><span>发出之后，计时器会复位，接收到下一个数据包时，会再次启动 200 毫秒的计时器。为了提升应用程序</span><br><span>在内部网和 Internet 上的传输性能，Microsoft TCP 栈使用了下面的策略来决定在接收到数据包后</span><br><span>什么时候发送 ACK 确认数据包：</span><br><span>1、如果在 200 毫秒的计时器超时之前，接收到下一个数据包，则立即发送 ACK 确认数据包。</span><br><span>2、如果当前恰好有数据包需要发给 ACK 确认信息的接收端，则把 ACK 确认信息附带在数据包上立即发送。</span><br><span>3、当计时器超时，ACK 确认信息立即发送。</span><br><span>为了避免小数据包拥塞网络，Microsoft TCP 栈默认启用了 Nagle 算法，这个算法能够将应用程序多次</span><br><span>调用 Send 发送的数据拼接起来，当收到前一个数据包的 ACK 确认信息时，一起发送出去。下面是 Nagle</span><br><span>算法的例外情况：</span><br><span>1、如果 Microsoft TCP 栈拼接起来的数据包超过了 MTU 值，这个数据会立即发送，而不等待前一个数据</span><br><span>包的 ACK 确认信息。在以太网中，TCP 的 MTU(Maximum Transmission Unit) 值是 1460 字节。</span><br><span>2、如果设置了 TCP_NODELAY 选项，就会禁用 Nagle 算法，应用程序调用 Send 发送的数据包会立即被</span><br><span>投递到网络，而没有延迟。</span><br><span>为了在应用层优化性能，Winsock 把应用程序调用 Send 发送的数据从应用程序的缓冲区复制到 Winsock</span><br><span>内核缓冲区。Microsoft TCP 栈利用类似 Nagle 算法的方法，决定什么时候才实际地把数据投递到网络。</span><br><span>内核缓冲区的默认大小是 8K，使用 SO_SNDBUF 选项，可以改变 Winsock 内核缓冲区的大小。如果有必要的话，</span><br><span>Winsock 能缓冲大于 SO_SNDBUF 缓冲区大小的数据。在绝大多数情况下，应用程序完成 Send 调用仅仅表明数据</span><br><span>被复制到了 Winsock 内核缓冲区，并不能说明数据就实际地被投递到了网络上。唯一一种例外的情况是：</span><br><span>通过设置 SO_SNDBUT 为 0 禁用了 Winsock 内核缓冲区。</span></p><br><p><span>Winsock 使用下面的规则来向应用程序表明一个 Send 调用的完成：</span><br><span>1、如果 socket 仍然在 SO_SNDBUF 限额内，Winsock 复制应用程序要发送的数据到内核缓冲区，完成 Send 调用。</span><br><span>2、如果 Socket 超过了 SO_SNDBUF 限额并且先前只有一个被缓冲的发送数据在内核缓冲区，Winsock 复制要发送</span><br><span>的数据到内核缓冲区，完成 Send 调用。</span><br><span>3、如果 Socket 超过了 SO_SNDBUF 限额并且内核缓冲区有不只一个被缓冲的发送数据，Winsock 复制要发送的数据</span><br><span>到内核缓冲区，然后投递数据到网络，直到 Socket 降到 SO_SNDBUF 限额内或者只剩余一个要发送的数据，才</span><br><span>完成 Send 调用。</span></p><br><p><span>案例 1</span><br><span>一个 Winsock TCP 客户端需要发送 10000 个记录到 Winsock TCP 服务端，保存到数据库。记录大小从 20 字节到 100</span><br><span>字节不等。对于简单的应用程序逻辑，可能的设计方案如下：</span><br><span>1、客户端以阻塞方式发送，服务端以阻塞方式接收。</span><br><span>2、客户端设置 SO_SNDBUF 为 0，禁用 Nagle 算法，让每个数据包单独的发送。</span><br><span>3、服务端在一个循环中调用 Recv 接收数据包。给 Recv 传递 200 字节的缓冲区以便让每个记录在一次 Recv 调用中</span><br><span>被获取到。</span></p><br><p><span>性能：</span><br><span>在测试中发现，客户端每秒只能发送 5 条数据到服务段，总共 10000 条记录，976K 字节左右，用了半个多小时</span><br><span>才全部传到服务器。</span></p><br><p><span>分析：</span><br><span>因为客户端没有设置 TCP_NODELAY 选项，Nagle 算法强制 TCP 栈在发送数据包之前等待前一个数据包的 ACK 确认</span><br><span>信息。然而，客户端设置 SO_SNDBUF 为 0，禁用了内核缓冲区。因此，10000 个 Send 调用只能一个数据包一个数据</span><br><span>包的发送和确认，由于下列原因，每个 ACK 确认信息被延迟 200 毫秒：</span><br><span>1、当服务器获取到一个数据包，启动一个 200 毫秒的计时器。</span><br><span>2、服务端不需要向客户端发送任何数据，所以，ACK 确认信息不能被发回的数据包顺路携带。</span><br><span>3、客户端在没有收到前一个数据包的确认信息前，不能发送数据包。</span><br><span>4、服务端的计时器超时后，ACK 确认信息被发送到客户端。</span></p><br><p><span>如何提高性能：</span><br><span>在这个设计中存在两个问题。第一，存在延时问题。客户端需要能够在 200 毫秒内发送两个数据包到服务端。</span><br><span>因为客户端默认情况下使用 Nagle 算法，应该使用默认的内核缓冲区，不应该设置 SO_SNDBUF 为 0。一旦 TCP</span><br><span>栈拼接起来的数据包超过 MTU 值，这个数据包会立即被发送，不用等待前一个 ACK 确认信息。第二，这个设计</span><br><span>方案对每一个如此小的的数据包都调用一次 Send。发送这么小的数据包是不很有效率的。在这种情况下，应该</span><br><span>把每个记录补充到 100 字节并且每次调用 Send 发送 80 个记录。为了让服务端知道一次总共发送了多少个记录，</span><br><span>客户端可以在记录前面带一个头信息。</span></p><br><p><span>案例二：</span><br><span>一个 Winsock TCP 客户端程序打开两个连接和一个提供股票报价服务的 Winsock TCP 服务端通信。第一个连接</span><br><span>作为命令通道用来传输股票编号到服务端。第二个连接作为数据通道用来接收股票报价。两个连接被建立后，</span><br><span>客户端通过命令通道发送股票编号到服务端，然后在数据通道上等待返回的股票报价信息。客户端在接收到第一</span><br><span>个股票报价信息后发送下一个股票编号请求到服务端。客户端和服务端都没有设置 SO_SNDBUF 和 TCP_NODELAY</span><br><span>选项。</span></p><br><p><span>性能：</span><br><span>测试中发现，客户端每秒只能获取到 5 条报价信息。</span></p><br><p><span>分析：</span></p><br><p><span>这个设计方案一次只允许获取一条股票信息。第一个股票编号信息通过命令通道发送到服务端，立即接收到</span><br><span>服务端通过数据通道返回的股票报价信息。然后，客户端立即发送第二条请求信息，send 调用立即返回，</span><br><span>发送的数据被复制到内核缓冲区。然而，TCP 栈不能立即投递这个数据包到网络，因为没有收到前一个数据包的</span><br><span>ACK 确认信息。200 毫秒后，服务端的计时器超时，第一个请求数据包的 ACK 确认信息被发送回客户端，客户端</span><br><span>的第二个请求包才被投递到网络。第二个请求的报价信息立即从数据通道返回到客户端，因为此时，客户端的</span><br><span>计时器已经超时，第一个报价信息的 ACK 确认信息已经被发送到服务端。这个过程循环发生。</span></p><br><p><span>如何提高性能：</span><br><span>在这里，两个连接的设计是没有必要的。如果使用一个连接来请求和接收报价信息，股票请求的 ACK 确认信息会</span><br><span>被返回的报价信息立即顺路携带回来。要进一步的提高性能，客户端应该一次调用 Send 发送多个股票请求，服务端</span><br><span>一次返回多个报价信息。如果由于某些特殊原因必须要使用两个单向的连接，客户端和服务端都应该设置 TCP_NODELAY</span><br><span>选项，让小数据包立即发送而不用等待前一个数据包的 ACK 确认信息。</span></p><br><p><span>提高性能的建议：</span><br><span>上面两个案例说明了一些最坏的情况。当设计一个方案解决大量的小数据包发送和接收时，应该遵循以下的建议：</span><br><span>1、如果数据片段不需要紧急传输的话，应用程序应该将他们拼接成更大的数据块，再调用 Send。因为发送缓冲区</span><br><span>很可能被复制到内核缓冲区，所以缓冲区不应该太大，通常比 8K 小一点点是很有效率的。只要 Winsock 内核缓冲区</span><br><span>得到一个大于 MTU 值的数据块，就会发送若干个数据包，剩下最后一个数据包。发送方除了最后一个数据包，都不会</span><br><span>被 200 毫秒的计时器触发。</span><br><span>2、如果可能的话，避免单向的 Socket 数据流接连。</span><br><span>3、不要设置 SO_SNDBUF 为 0，除非想确保数据包在调用 Send 完成之后立即被投递到网络。事实上，8K 的缓冲区适合大多数</span><br><span>情况，不需要重新改变，除非新设置的缓冲区经过测试的确比默认大小更高效。</span><br><span>4、如果数据传输不用保证可靠性，使用 UDP。</span></p></div>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/14/sci/mcmcgibbs/" itemprop="url">
                  MCMC&Gibbs Sampling学习
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-05-14T23:27:07+08:00" content="2016-05-14">
              2016-05-14
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/science/" itemprop="url" rel="index">
                    <span itemprop="name">science</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/14/sci/mcmcgibbs/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/14/sci/mcmcgibbs/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>给定一个简单的概率分布$p(x)$（比如均匀分布、正态分布），生成它的样本是比较容易的。但是当目标概率分布很复杂时，要生成它的样本就会变得十分困难。MCMC（蒙特卡洛马尔科夫方法）算法就是一种常用的生成复杂目标概率分布样本的算法。</p>
<p>MCMC的基础是非周期马氏链的平稳特性：从任意状态出发，最后都会到达平稳状态。当达到平稳状态后，每一次采样得到的样本$x$都服从平稳分布$\pi$。如果平稳分布$\pi$就是目标分布的话，那么我们就找到了一种生成目标概率分布样本的方法，MCMC就是使得$\pi$成为目标分布的方法。</p>
<p>具体算法推导参考：<a href="http://cos.name/2013/01/lda-math-mcmc-and-gibbs-sampling/" target="_blank" rel="external">MCMC和Gibbs Sampling</a></p>
<p>MCMC需要已知目标概率分布$p(x)$和一个任意分布$q(x|y)$</p>
<p>算法如下：</p>
<ol>
<li><p>初始化马氏链状态X=x0</p>
</li>
<li><p>对t=0,1,2…循环采样</p>
<ul>
<li><p>采样$y\sim q(x|y)$</p>
</li>
<li><p>从均匀分布采样$u\sim U(0,1)$</p>
</li>
<li><p>如果<span>$u&lt;\alpha(x_y,y)=min\{\frac{p(y)q(x_t|y)}{p(x_t)q(y|x_t)},1\}$</span><!-- Has MathJax -->，接受新样本y，X=y，否则$X=x_t$</p>
</li>
</ul>
</li>
</ol>
<p>选取分布$q(x|y)$时，往往需要满足对称性，$q(x|y)=q(y|x)$，也就是x-&gt;y与y-&gt;x的概率相同，这样<span>$\alpha(x_y,y)=min\{\frac{p(y)}{p(x_t)},1\}$</span><!-- Has MathJax --></p>
<p>$q(x|y)$常选择以y为中心的高斯分布，这样越靠近y的值越可能在下一次被访问，这样的样本序列就是一个<a href="https://en.wikipedia.org/wiki/Random_walk" target="_blank" rel="external"><strong>随机行走过程</strong></a>。</p>
<p>可以看到如果新的样本y处在$p$的高密度区域（$p(y)&gt;p(x)$），则y总是被接受的，否则y可能被拒绝。直观上讲，被接受的样本总是以较大的概率落在$p(x)$的高密度区域，而以小概率落在$p(x)$的低密度区域（被拒绝），因此接受的样本序列大致服从$p(x)$的概率分布。</p>
<p>MCMC虽然能够有效的生成复杂概率分布的样本，但也有几个显著的缺点：</p>
<ol>
<li>样本是相干的，由于采用马氏链生成，相邻的样本并不独立，解决该问题可以通过增加<em>jumping size</em>，即再次从采样序列抽样。</li>
<li>初始分布并不服从平稳分布，有一个<em>burn-in</em>的过程，导致算法可能需要迭代n次后，采样的分布才服从目标分布。</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/09/tech/设计模式解析学习/" itemprop="url">
                  设计模式解析学习
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-05-09T15:51:35+08:00" content="2016-05-09">
              2016-05-09
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/technology/" itemprop="url" rel="index">
                    <span itemprop="name">technology</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/09/tech/设计模式解析学习/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/09/tech/设计模式解析学习/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="面向对象范形"><a href="#面向对象范形" class="headerlink" title="面向对象范形"></a>面向对象范形</h1><h2 id="面向过程：功能分解"><a href="#面向过程：功能分解" class="headerlink" title="面向过程：功能分解"></a>面向过程：功能分解</h2><p>将一个大任务分解为一个个小任务，但是主程序需要承受的责任太多（为每个子任务分配资源，确保子任务正确运行，etc）</p>
<p>功能分解往往导致低内聚，高耦合。    </p>
<h2 id="面向对象"><a href="#面向对象" class="headerlink" title="面向对象"></a>面向对象</h2><p>对象具有<strong>责任</strong>，降低主程序的复杂操作。</p>
<p>封装使得耦合性降低。 </p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/09/tech/Java-concurrent包学习/" itemprop="url">
                  Java concurrent包学习
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-05-09T15:47:21+08:00" content="2016-05-09">
              2016-05-09
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/technology/" itemprop="url" rel="index">
                    <span itemprop="name">technology</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/09/tech/Java-concurrent包学习/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/09/tech/Java-concurrent包学习/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>JDK5.0对java.util.concurrent包做了大量的改进，吸收了大量的由 <a href="https://en.wikipedia.org/wiki/Doug_Lea" target="_blank" rel="external">Doug Lea</a> 编写的util.concurrent包中的内容。</p>
<p>这里记录一下我对java.util.concurrent包学习的总结。</p>
<p>摘要自其他文章</p>
<blockquote>
<p>JDK 5.0 中的并发改进可以分为三组:</p>
<ul>
<li><p>JVM 级别更改。大多数现代处理器对并发对某一硬件级别提供支持，通常以compare-and-swap （CAS）指令形式。CAS 是一种低级别的、细粒度的技术，它允许多个线程更新一个内存位置，同时能够检测其他线程的冲突并进行恢复。它是许多高性能并发算法的基础。在 JDK 5.0 之前，Java 语言中用于协调线程之间的访问的惟一原语是同步，同步是更重量级和粗粒度的。公开 CAS 可以开发高度可伸缩的并发 Java 类。这些更改主要由 JDK 库类使用，而不是由开发人员使用。</p>
</li>
<li><p>低级实用程序类 – 锁定和原子类。使用 CAS 作为并发原语，ReentrantLock 类提供与 synchronized 原语相同的锁定和内存语义，然而这样可以更好地控制锁定（如计时的锁定等待、锁定轮询和可中断的锁定等待）和提供更好的可伸缩性（竞争时的高性能）。大多数开发人员将不再直接使用ReentrantLock 类，而是使用在 ReentrantLock 类上构建的高级类。</p>
</li>
<li><p>高级实用程序类。这些类实现并发构建块，每个计算机科学文本中都会讲述这些类 – 信号、互斥、闩锁、屏障、交换程序、线程池和线程安全集合类等。大部分开发人员都可以在应用程序中用这些类，来替换许多（如果不是全部）同步、wait() 和 notify() 的使用，从而提高性能、可读性和正确性。</p>
</li>
</ul>
</blockquote>
<p>可以看到最重要的就是引入了 CAS 这个操作，AtomicXXX，ReentrantLock 都以 CAS 来实现。</p>
<p>那么 CAS 是什么呢， CAS 是现代CPU支持的一条指令，操作数有三个，分别是 addr, expect, value，如果当前值与 expect 相同时，那么就该值写为 value 并返回 true，否则返回 false。由于 CAS 是一条指令，可以保证操作的原子性。</p>
<p>为什么需要 CAS 呢？来看一看这个例子，这个例子试图实现某个方法同时只有一个线程访问，一个简单的想法就是定义一个标志位 flag，当 flag 被设置时，说明该方法正在被访问，因此其他线程不能够访问，代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="number">1</span> <span class="keyword">volatile</span> <span class="keyword">int</span> flag=<span class="number">0</span>;</div><div class="line"><span class="number">2</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method1</span><span class="params">()</span></span>&#123;</div><div class="line"><span class="number">3</span>     <span class="keyword">while</span>(flag==<span class="number">1</span>)</div><div class="line"><span class="number">4</span>         waiting...</div><div class="line"><span class="number">5</span>     flag=<span class="number">1</span>;</div><div class="line"><span class="number">6</span>     dosomework;</div><div class="line"><span class="number">7</span>     flag=<span class="number">0</span>;</div><div class="line"><span class="number">8</span> &#125;</div></pre></td></tr></table></figure></p>
<p>问题在于，flag==1 到 flag=1 这个过程并不是原子的，假设有两个线程t1,t2。flag 初始等于0，当 t1 执行到第3行后被挂起，t2 执行到第3行时 flag 仍然为0，method1 被两个线程同时运行。虽然我们已经将 flag 申明为 volatile 保证 flag 对不同线程的可见性，但是仍然不能够实现我们的需求。所以 Java 提供了 <strong>synchronized</strong> 这个关键字对线程同步提供 JVM 级别的实现。</p>
<p>CAS 可以认为是一个乐观锁，类似于数据库中的版本控制。使用 CAS 的一般形式为：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">do&#123;</div><div class="line">    备份旧数据；  </div><div class="line">    基于旧数据构造新数据；  </div><div class="line">&#125;<span class="keyword">while</span>(!CAS( 内存地址，备份的旧数据，新数据 ))</div></pre></td></tr></table></figure></p>
<p>有了 CAS 后，我们就可以实现支持原子操作的数据类型，如 AtomicXXX ，还有提供线程同步的锁 Lock，因为这时的比较和赋值成为一个原子操作（3到5行），所以可以实现正确的逻辑。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/09/tech/杂七杂八的Linux-Shell脚本学习/" itemprop="url">
                  杂七杂八的Linux Shell脚本学习
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-05-09T15:46:37+08:00" content="2016-05-09">
              2016-05-09
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/technology/" itemprop="url" rel="index">
                    <span itemprop="name">technology</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/09/tech/杂七杂八的Linux-Shell脚本学习/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/09/tech/杂七杂八的Linux-Shell脚本学习/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文为[Linux Shell Scripting Cookbook]学习记录，枚举了一些常用的命令。</p>
<h2 id="tr"><a href="#tr" class="headerlink" title="tr"></a>tr</h2><p><code>tr [options] set1 set2</code><br>translate 命令，用于将输入字符从set1映射到set2。<br>如<code>tr [A-Z] [a-z]</code>将字符全部转换为小写。</p>
<p>options有许多用法，<code>-s</code>可以压缩字符，<code>-d</code>可以删除字符</p>
<h2 id="sort"><a href="#sort" class="headerlink" title="sort"></a>sort</h2><p><code>sort [options] file</code><br>sort 命令，用于将输入按行排序。</p>
<p>options用法， <code>-r</code>逆序排序，<code>-u</code>相同行只输出一次</p>
<h2 id="uniq"><a href="#uniq" class="headerlink" title="uniq"></a>uniq</h2><p>uniq 命令，用于输出唯一行，注意uniq只对相临行作检测，也就是说<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">123</div><div class="line">321</div><div class="line">123</div></pre></td></tr></table></figure></p>
<p>依然输出<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">123</div><div class="line">321</div><div class="line">123</div></pre></td></tr></table></figure></p>
<p>因此uniq常常和sort联合使用。常用选项<code>-c</code>，统计出现数目。</p>
<h2 id="cut-paste"><a href="#cut-paste" class="headerlink" title="cut, paste"></a>cut, paste</h2><p>cut切分列，paste粘贴列</p>
<h2 id="sed"><a href="#sed" class="headerlink" title="sed"></a>sed</h2><p>sed替换文本模式，删除文本模式</p>
<h2 id="awk"><a href="#awk" class="headerlink" title="awk"></a>awk</h2><p>awk太博大精深了，参考-&gt;<a href="http://www.cnblogs.com/ggjucheng/archive/2013/01/13/2858470.html" target="_blank" rel="external">linux awk 命令详解</a></p>
<h2 id="grep"><a href="#grep" class="headerlink" title="grep"></a>grep</h2><p>查找模式，常用选项<code>-o</code>，仅输出匹配的内容。grep也常常和sort，uniq等联合使用，比如统计词频可以这么做：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grep -o <span class="string">'\b\w+\b'</span> xxxfile|sort|uniq -c</div></pre></td></tr></table></figure></p>
<h2 id="tar-gzip-zip"><a href="#tar-gzip-zip" class="headerlink" title="tar, gzip, zip"></a>tar, gzip, zip</h2><p>tar创建归档文件，gzip创建压缩文件，zip可以同时完成归档和压缩功能。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/09/tech/自己实现一个vector类/" itemprop="url">
                  自己实现一个vector类
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-04-09T15:50:56+08:00" content="2016-04-09">
              2016-04-09
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/technology/" itemprop="url" rel="index">
                    <span itemprop="name">technology</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/04/09/tech/自己实现一个vector类/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/04/09/tech/自己实现一个vector类/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>准备面试，看到很多人说遇到面试官让自己在纸上写一个std类，所以我就拿std::vector作为练手。</p>
<p>主要思想就是使用swap保证异常安全性，遵守<code>Effective C++</code>的一些item，比如从<code>copy-constructor</code>和<code>assign-constructor</code>提取共同的代码组成<code>init</code>函数。</p>
<p>虽然代码比较简单，但还是出现了越界等问题调试了很久，可能手太生了，以后得多练练！<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;utility&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"></div><div class="line"><span class="keyword">class</span> myvec &#123;</div><div class="line"><span class="keyword">private</span>:</div><div class="line">    <span class="keyword">int</span> *mdata = <span class="literal">nullptr</span>;</div><div class="line">    <span class="keyword">int</span> msize = <span class="number">11</span>;</div><div class="line">    <span class="keyword">int</span> mlastidx = <span class="number">-1</span>;</div><div class="line"> </div><div class="line">     <span class="function"><span class="keyword">void</span> <span class="title">ensureSize</span><span class="params">()</span> </span>&#123;</div><div class="line">         <span class="keyword">if</span> (msize &lt;= mlastidx + <span class="number">1</span>) &#123;</div><div class="line">             reserve(msize * <span class="number">2</span>);</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line"> </div><div class="line">     <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">const</span> myvec &amp;vec)</span> </span>&#123;</div><div class="line">         <span class="keyword">if</span> (&amp;vec == <span class="keyword">this</span>)</div><div class="line">             <span class="keyword">return</span>;</div><div class="line"> </div><div class="line">         <span class="function">myvec <span class="title">newvec</span><span class="params">(vec.msize)</span></span>;</div><div class="line"> </div><div class="line">         <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= vec.mlastidx; ++i) &#123;</div><div class="line">             newvec.insert(vec.mdata[i]);</div><div class="line">         &#125;</div><div class="line"> </div><div class="line">         swap(newvec);</div><div class="line">     &#125;</div><div class="line"> </div><div class="line"> <span class="keyword">public</span>:</div><div class="line">     myvec() : myvec(<span class="number">11</span>) &#123;</div><div class="line"> </div><div class="line">     &#125;</div><div class="line"> </div><div class="line">     myvec(<span class="keyword">int</span> capacity) : msize(capacity) &#123;</div><div class="line">         <span class="keyword">try</span> &#123;</div><div class="line">             mdata = <span class="keyword">new</span> <span class="keyword">int</span>[capacity];</div><div class="line">         &#125;</div><div class="line">         <span class="keyword">catch</span> (<span class="keyword">const</span> <span class="built_in">std</span>::bad_alloc &amp;e) &#123;</div><div class="line">             <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; e.what() &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</div><div class="line">             <span class="built_in">abort</span>();</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line"> </div><div class="line">     myvec(<span class="keyword">const</span> myvec &amp;vec) &#123;</div><div class="line">         init(vec);</div><div class="line">     &#125;</div><div class="line"> </div><div class="line">     ~myvec() &#123;</div><div class="line">         <span class="keyword">delete</span>[] mdata;</div><div class="line">         <span class="built_in">std</span>::<span class="built_in">cout</span>&lt;&lt;<span class="string">"deconstructed"</span>&lt;&lt;<span class="built_in">std</span>::<span class="built_in">endl</span>;</div><div class="line">     &#125;</div><div class="line"> </div><div class="line">     <span class="keyword">const</span> myvec &amp;<span class="keyword">operator</span>=(<span class="keyword">const</span> myvec &amp;vec) &#123;</div><div class="line">         init(vec);</div><div class="line">         <span class="keyword">return</span> *<span class="keyword">this</span>;</div><div class="line">     &#125;</div><div class="line"> </div><div class="line">     <span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</div><div class="line">         <span class="keyword">return</span> mlastidx + <span class="number">1</span>;</div><div class="line">     &#125;</div><div class="line"> </div><div class="line">     <span class="keyword">int</span> &amp;<span class="keyword">operator</span>[](<span class="keyword">int</span> index) &#123;</div><div class="line">         <span class="keyword">if</span> (index &lt; <span class="number">0</span> || index &gt; mlastidx)</div><div class="line">             <span class="keyword">throw</span> <span class="string">"invalid access"</span>;</div><div class="line">         <span class="keyword">return</span> mdata[index];</div><div class="line">     &#125;</div><div class="line"> </div><div class="line">     <span class="function"><span class="keyword">void</span> <span class="title">swap</span><span class="params">(myvec &amp;other)</span> </span>&#123;</div><div class="line">         <span class="built_in">std</span>::swap(<span class="keyword">this</span>-&gt;msize, other.msize);</div><div class="line">         <span class="built_in">std</span>::swap(<span class="keyword">this</span>-&gt;mdata, other.mdata);</div><div class="line">         <span class="built_in">std</span>::swap(<span class="keyword">this</span>-&gt;mlastidx, other.mlastidx);</div><div class="line"> </div><div class="line">     &#125;</div><div class="line"> </div><div class="line">     <span class="function"><span class="keyword">void</span> <span class="title">reserve</span><span class="params">(<span class="keyword">int</span> capacity)</span> </span>&#123;</div><div class="line">         <span class="keyword">if</span> (capacity &lt;= mlastidx) &#123;</div><div class="line">             <span class="keyword">return</span>;</div><div class="line">         &#125;</div><div class="line">         <span class="function">myvec <span class="title">newvec</span><span class="params">(capacity)</span></span>;</div><div class="line"> </div><div class="line">         <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= mlastidx; ++i) &#123;</div><div class="line">             newvec.insert(mdata[i]);</div><div class="line">         &#125;</div><div class="line"> </div><div class="line">         swap(newvec);</div><div class="line">     &#125;</div><div class="line"> </div><div class="line">     <span class="function"><span class="keyword">bool</span> <span class="title">empty</span><span class="params">()</span> </span>&#123;</div><div class="line">         <span class="keyword">return</span> mlastidx == <span class="number">-1</span>;</div><div class="line">     &#125;</div><div class="line"> </div><div class="line">     <span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(<span class="keyword">int</span> val)</span> </span>&#123;</div><div class="line">         ensureSize();</div><div class="line">         mlastidx++;</div><div class="line">         mdata[mlastidx] = val;</div><div class="line">     &#125;</div><div class="line"> </div><div class="line">     <span class="function"><span class="keyword">void</span> <span class="title">erase</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (index &lt; <span class="number">0</span> || index &gt; mlastidx) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = index; i &lt; mlastidx; ++i) &#123;</div><div class="line">            mdata[i] = mdata[i + <span class="number">1</span>];</div><div class="line">        &#125;</div><div class="line">        mlastidx--;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">find</span><span class="params">(<span class="keyword">int</span> val)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= mlastidx; ++i) &#123;</div><div class="line">            <span class="keyword">if</span> (mdata[i] == val) &#123;</div><div class="line">                <span class="keyword">return</span> i;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">count</span><span class="params">(<span class="keyword">int</span> val)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> cnt = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= mlastidx; ++i) &#123;</div><div class="line">            <span class="keyword">if</span> (mdata[i] == val) &#123;</div><div class="line">                cnt++;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> cnt;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="function">myvec <span class="title">newvec</span><span class="params">(msize)</span></span>;</div><div class="line">        swap(newvec);</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Glyme" />
          <p class="site-author-name" itemprop="name">Glyme</p>
          <p class="site-description motion-element" itemprop="description">记录我的学习、生活点滴</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">15</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">8</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Glyme</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"glyme"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]]}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->

  
    
  





  
  
  

  

  

</body>
</html>
